<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/blog.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/blog.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/yqq/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":true},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="NeRO代码liuyuan-pal&#x2F;NeRO: [SIGGRAPH2023] NeRO: Neural Geometry and BRDF Reconstruction of Reflective Objects from Multiview Images (github.com)">
<meta property="og:type" content="article">
<meta property="og:title" content="NeRO-code">
<meta property="og:url" content="http://example.com/3DReconstruction/Multi-view/Implicit%20Function/NeRF-based/Shadow&Highlight/NeRO-code/index.html">
<meta property="og:site_name" content="QiYun">
<meta property="og:description" content="NeRO代码liuyuan-pal&#x2F;NeRO: [SIGGRAPH2023] NeRO: Neural Geometry and BRDF Reconstruction of Reflective Objects from Multiview Images (github.com)">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728142918.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230803160338.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230803160313.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728142918.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/SDFNetwork_modify.png">
<meta property="og:image" content="https://raw.githubusercontent.com/yq010105/Blog_images/main/Pasted%20image%2020221206180113.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230803155215.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728143216.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/render_core.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/occ.png">
<meta property="og:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230805163513.png">
<meta property="article:published_time" content="2023-08-01T07:17:39.000Z">
<meta property="article:modified_time" content="2023-11-24T06:43:42.195Z">
<meta property="article:author" content="Qi Yun">
<meta property="article:tag" content="Python">
<meta property="article:tag" content="Neus">
<meta property="article:tag" content="Code">
<meta property="article:tag" content="Shadow&amp;Highlight">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728142918.png">

<link rel="canonical" href="http://example.com/3DReconstruction/Multi-view/Implicit%20Function/NeRF-based/Shadow&Highlight/NeRO-code/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>NeRO-code | QiYun</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<!-- hexo injector head_end start -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/hexo-math@4.0.0/dist/style.css">
<!-- hexo injector head_end end --></head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">QiYun</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Note</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>Search
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="Searching..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/3DReconstruction/Multi-view/Implicit%20Function/NeRF-based/Shadow&Highlight/NeRO-code/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="Qi Yun">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="QiYun">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          NeRO-code
        </h1>

        <div class="post-meta">
          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-08-01 15:17:39" itemprop="dateCreated datePublished" datetime="2023-08-01T15:17:39+08:00">2023-08-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-11-24 14:43:42" itemprop="dateModified" datetime="2023-11-24T14:43:42+08:00">2023-11-24</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/3DReconstruction-Multi-view-Implicit-Function-NeRF-based-Shadow-Highlight/" itemprop="url" rel="index"><span itemprop="name">3DReconstruction/Multi-view/Implicit Function/NeRF-based/Shadow&Highlight</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
              <span>3.3k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>NeRO代码<a target="_blank" rel="noopener" href="https://github.com/liuyuan-pal/NeRO">liuyuan-pal/NeRO: [SIGGRAPH2023] NeRO: Neural Geometry and BRDF Reconstruction of Reflective Objects from Multiview Images (github.com)</a></p>
<p><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728142918.png" alt="image.png"></p>
<span id="more"></span>
<h1 id="Dataset"><a href="#Dataset" class="headerlink" title="Dataset"></a>Dataset</h1><h2 id="DummyDataset-Dataset"><a href="#DummyDataset-Dataset" class="headerlink" title="DummyDataset(Dataset)"></a>DummyDataset(Dataset)</h2><p><code>name2dataset[self.cfg[&#39;train_dataset_type&#39;]](self.cfg[&#39;train_dataset_cfg&#39;], True)</code><br>相当于：<code>DummyDataset(self.cfg[&#39;train_dataset_cfg&#39;], True)</code></p>
<ul>
<li>is_train: <ul>
<li><code>__getitem__ : return &#123;&#125;</code></li>
<li><code>__len__ : return 99999999</code> </li>
</ul>
</li>
<li>else:<ul>
<li><code>__getitem__ : return &#123;&#39;index&#39;: index&#125;</code></li>
<li><code>__len__ : return self.test_num</code> </li>
</ul>
</li>
</ul>
<p>not is_train:<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> is_train:</span><br><span class="line">    <span class="comment"># return 一个实例 eg：GlossyRealDatabase(self.cfg[&#x27;database_name&#x27;])</span></span><br><span class="line">    database = parse_database_name(self.cfg[<span class="string">&#x27;database_name&#x27;</span>])</span><br><span class="line">    <span class="comment"># 使用database中的get_img_ids方法，获取train_ids和test_ids</span></span><br><span class="line">    train_ids, test_ids = get_database_split(database, <span class="string">&#x27;validation&#x27;</span>)</span><br><span class="line">    self.train_num = <span class="built_in">len</span>(train_ids)</span><br><span class="line">    self.test_num = <span class="built_in">len</span>(test_ids)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;val&#x27;</span> , is_train)</span><br></pre></td></tr></table></figure></p>
<p><strong>database.py</strong>:</p>
<ul>
<li>parse_database_name</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">parse_database_name</span>(<span class="params">database_name:<span class="built_in">str</span></span>)-&gt;BaseDatabase:</span><br><span class="line">    name2database=&#123;</span><br><span class="line">        <span class="string">&#x27;syn&#x27;</span>: GlossySyntheticDatabase,</span><br><span class="line">        <span class="string">&#x27;real&#x27;</span>: GlossyRealDatabase,</span><br><span class="line">        <span class="string">&#x27;custom&#x27;</span>: CustomDatabase,</span><br><span class="line">    &#125;</span><br><span class="line">    database_type = database_name.split(<span class="string">&#x27;/&#x27;</span>)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">if</span> database_type <span class="keyword">in</span> name2database:</span><br><span class="line">        <span class="keyword">return</span> name2database[database_type](database_name)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br></pre></td></tr></table></figure>
<ul>
<li>get_database_split<ul>
<li>打乱self.img_ids，并split为test和train</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_database_split</span>(<span class="params">database: BaseDatabase, split_type=<span class="string">&#x27;validation&#x27;</span></span>):</span><br><span class="line">    <span class="keyword">if</span> split_type==<span class="string">&#x27;validation&#x27;</span>:</span><br><span class="line">        random.seed(<span class="number">6033</span>)</span><br><span class="line">        img_ids = database.get_img_ids()</span><br><span class="line">        random.shuffle(img_ids)</span><br><span class="line">        test_ids = img_ids[:<span class="number">1</span>]</span><br><span class="line">        train_ids = img_ids[<span class="number">1</span>:]</span><br><span class="line">    <span class="keyword">elif</span> split_type==<span class="string">&#x27;test&#x27;</span>:</span><br><span class="line">        test_ids, train_ids = read_pickle(<span class="string">&#x27;configs/synthetic_split_128.pkl&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">    <span class="keyword">return</span> train_ids, test_ids</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">f = open(&#x27;E:\\BaiduSyncdisk\\NeRF_Proj\\NeRO\\configs\\synthetic_split_128.pkl&#x27;,&#x27;rb&#x27;)</span></span><br><span class="line"><span class="string">[array([&#x27;0&#x27;, &#x27;4&#x27;, &#x27;19&#x27;, &#x27;2&#x27;, &#x27;127&#x27;, &#x27;71&#x27;, &#x27;73&#x27;, &#x27;56&#x27;, &#x27;75&#x27;, &#x27;95&#x27;, &#x27;93&#x27;,</span></span><br><span class="line"><span class="string">       &#x27;110&#x27;, &#x27;91&#x27;, &#x27;7&#x27;, &#x27;5&#x27;, &#x27;3&#x27;, &#x27;68&#x27;, &#x27;30&#x27;, &#x27;66&#x27;, &#x27;113&#x27;, &#x27;111&#x27;, &#x27;33&#x27;,</span></span><br><span class="line"><span class="string">       &#x27;120&#x27;, &#x27;31&#x27;, &#x27;29&#x27;, &#x27;14&#x27;, &#x27;49&#x27;, &#x27;11&#x27;, &#x27;109&#x27;, &#x27;61&#x27;, &#x27;59&#x27;, &#x27;57&#x27;],</span></span><br><span class="line"><span class="string">      dtype=&#x27;&lt;U3&#x27;), </span></span><br><span class="line"><span class="string">[&#x27;1&#x27;, &#x27;6&#x27;, &#x27;8&#x27;, &#x27;9&#x27;, &#x27;10&#x27;, &#x27;12&#x27;, &#x27;13&#x27;, &#x27;15&#x27;, &#x27;16&#x27;, &#x27;17&#x27;, &#x27;18&#x27;, &#x27;20&#x27;, &#x27;21&#x27;, &#x27;22&#x27;, &#x27;23&#x27;, &#x27;24&#x27;,</span></span><br><span class="line"><span class="string">&#x27;25&#x27;, &#x27;26&#x27;, &#x27;27&#x27;, &#x27;28&#x27;, &#x27;32&#x27;, &#x27;34&#x27;, &#x27;35&#x27;, &#x27;36&#x27;, &#x27;37&#x27;, &#x27;38&#x27;, &#x27;39&#x27;, &#x27;40&#x27;, &#x27;41&#x27;, &#x27;42&#x27;, &#x27;43&#x27;,</span></span><br><span class="line"><span class="string">&#x27;44&#x27;, &#x27;45&#x27;, &#x27;46&#x27;, &#x27;47&#x27;, &#x27;48&#x27;, &#x27;50&#x27;, &#x27;51&#x27;, &#x27;52&#x27;, &#x27;53&#x27;, &#x27;54&#x27;, &#x27;55&#x27;, &#x27;58&#x27;, &#x27;60&#x27;, &#x27;62&#x27;, &#x27;63&#x27;,</span></span><br><span class="line"><span class="string">&#x27;64&#x27;, &#x27;65&#x27;, &#x27;67&#x27;, &#x27;69&#x27;, &#x27;70&#x27;, &#x27;72&#x27;, &#x27;74&#x27;, &#x27;76&#x27;, &#x27;77&#x27;, &#x27;78&#x27;, &#x27;79&#x27;, &#x27;80&#x27;, &#x27;81&#x27;, &#x27;82&#x27;, &#x27;83&#x27;,</span></span><br><span class="line"><span class="string">&#x27;84&#x27;, &#x27;85&#x27;, &#x27;86&#x27;, &#x27;87&#x27;, &#x27;88&#x27;, &#x27;89&#x27;, &#x27;90&#x27;, &#x27;92&#x27;, &#x27;94&#x27;, &#x27;96&#x27;, &#x27;97&#x27;, &#x27;98&#x27;, &#x27;99&#x27;, &#x27;100&#x27;, &#x27;101&#x27;,</span></span><br><span class="line"><span class="string">&#x27;102&#x27;, &#x27;103&#x27;, &#x27;104&#x27;, &#x27;105&#x27;, &#x27;106&#x27;, &#x27;107&#x27;, &#x27;108&#x27;, &#x27;112&#x27;, &#x27;114&#x27;, &#x27;115&#x27;, &#x27;116&#x27;, &#x27;117&#x27;,</span></span><br><span class="line"><span class="string">&#x27;118&#x27;, &#x27;119&#x27;, &#x27;121&#x27;, &#x27;122&#x27;, &#x27;123&#x27;, &#x27;124&#x27;, &#x27;125&#x27;, &#x27;126&#x27;]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h2 id="GlossyRealDatabase"><a href="#GlossyRealDatabase" class="headerlink" title="GlossyRealDatabase"></a>GlossyRealDatabase</h2><h3 id="init"><a href="#init" class="headerlink" title="init"></a>init</h3><ul>
<li>meta_info</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meta_info=&#123;</span><br><span class="line">    <span class="string">&#x27;bear&#x27;</span>: &#123;<span class="string">&#x27;forward&#x27;</span>: np.asarray([<span class="number">0.539944</span>,-<span class="number">0.342791</span>,<span class="number">0.341446</span>],np.float32), <span class="string">&#x27;up&#x27;</span>: np.asarray((<span class="number">0.0512875</span>,-<span class="number">0.645326</span>,-<span class="number">0.762183</span>),np.float32),&#125;,</span><br><span class="line">    <span class="string">&#x27;coral&#x27;</span>: &#123;<span class="string">&#x27;forward&#x27;</span>: np.asarray([<span class="number">0.004226</span>,-<span class="number">0.235523</span>,<span class="number">0.267582</span>],np.float32), <span class="string">&#x27;up&#x27;</span>: np.asarray((<span class="number">0.0477973</span>,-<span class="number">0.748313</span>,-<span class="number">0.661622</span>),np.float32),&#125;,</span><br><span class="line">    <span class="string">&#x27;maneki&#x27;</span>: &#123;<span class="string">&#x27;forward&#x27;</span>: np.asarray([-<span class="number">2.336584</span>, -<span class="number">0.406351</span>, <span class="number">0.482029</span>], np.float32), <span class="string">&#x27;up&#x27;</span>: np.asarray((-<span class="number">0.0117387</span>, -<span class="number">0.738751</span>, -<span class="number">0.673876</span>), np.float32), &#125;,</span><br><span class="line">    <span class="string">&#x27;bunny&#x27;</span>: &#123;<span class="string">&#x27;forward&#x27;</span>: np.asarray([<span class="number">0.437076</span>,-<span class="number">1.672467</span>,<span class="number">1.436961</span>],np.float32), <span class="string">&#x27;up&#x27;</span>: np.asarray((-<span class="number">0.0693234</span>,-<span class="number">0.644819</span>,-<span class="number">.761185</span>),np.float32),&#125;,</span><br><span class="line">    <span class="string">&#x27;vase&#x27;</span>: &#123;<span class="string">&#x27;forward&#x27;</span>: np.asarray([-<span class="number">0.911907</span>, -<span class="number">0.132777</span>, <span class="number">0.180063</span>], np.float32), <span class="string">&#x27;up&#x27;</span>: np.asarray((-<span class="number">0.01911</span>, -<span class="number">0.738918</span>, -<span class="number">0.673524</span>), np.float32), &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>从CloudCampare中获取的数据，其中forward是手动设置的前向，up是根据手动截取的一小块平面的法向<br><a target="_blank" rel="noopener" href="https://github.com/liuyuan-pal/NeRO/blob/main/custom_object.md">NeRO/custom_object.md at main · liuyuan-pal/NeRO (github.com)</a></p>
<div style="display:flex; justify-content:space-between;"> <img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230803160338.png" alt="Image 1" style="width:50%;"><div style="width:10px;"></div> <img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230803160313.png" alt="Image 2" style="width:50%;"> </div>

<ul>
<li><code>_parse_colmap</code> 从cache.pkl中读取数据，如果cache.pkl不存在，则从<code>/colmap/sparse/0</code>中读取并将数据写入到cache.pkl中<ul>
<li>self.poses (3,4), self.Ks (3,3), self.image_names(dict is img_ids : img_name), self.img_ids(list len is num_images)</li>
</ul>
</li>
<li><code>_normalize</code> 读取object_point_cloud.ply，获得截取出来的物体点云坐标，将该点云坐标标准化到单位bound中，并将世界基坐标系转换到手动设置的坐标系即up、forward<ul>
<li>即<code>_normalize</code>将点云坐标从原来的世界坐标系w转换到新的坐标系w’下</li>
<li>将pose的w2c数据转换为w’2c，其中w’原点在object_point_cloud.ply中心，xyz轴是自定义的轴，如上图，但是scale不变</li>
</ul>
</li>
<li><code>database_name: real/bear/raw_1024</code>中最后一个raw_1024<ul>
<li>如果以raw开头：<ul>
<li>将images中图片缩放并保存到images_raw_1024中</li>
<li>并更换self.Ks中数据（由于缩放了W、H）</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string"># f = open(&#x27;E:\\BaiduSyncdisk\\NeRF_Proj\\NeRO\\data\\GlossyReal\\bear\\cache.pkl&#x27;,&#x27;rb&#x27;)</span></span><br><span class="line"><span class="string">data:</span></span><br><span class="line"><span class="string">[&#123;1: array([[-0.21238244, -0.73007965,  0.6495209 , -0.28842232],</span></span><br><span class="line"><span class="string">       [ 0.4490811 ,  0.5174136 ,  0.7284294 , -2.9991536 ],</span></span><br><span class="line"><span class="string">       [-0.86788243,  0.44639313,  0.21797541,  3.0713193 ]],</span></span><br><span class="line"><span class="string">      dtype=float32), 2: array([[ 0.13014111, -0.75269127,  0.64538294, -0.3143167 ],</span></span><br><span class="line"><span class="string">       [ 0.47691151,  0.6181942 ,  0.624813  , -2.9732292 ],</span></span><br><span class="line"><span class="string">       [-0.8692633 ,  0.22647668,  0.43941963,  2.7372477 ]],</span></span><br><span class="line"><span class="string">        dtype=float32), </span></span><br><span class="line"><span class="string">       ...&#125;</span></span><br><span class="line"><span class="string">&#123;...96: array([[6.013423e+03, 0.000000e+00, 1.368000e+03],</span></span><br><span class="line"><span class="string">       [0.000000e+00, 6.013423e+03, 1.824000e+03],</span></span><br><span class="line"><span class="string">       [0.000000e+00, 0.000000e+00, 1.000000e+00]], dtype=float32), 97: array([[6.013423e+03, 0.000000e+00, 1.368000e+03],</span></span><br><span class="line"><span class="string">       [0.000000e+00, 6.013423e+03, 1.824000e+03],</span></span><br><span class="line"><span class="string">       [0.000000e+00, 0.000000e+00, 1.000000e+00]], dtype=float32)&#125;</span></span><br><span class="line"><span class="string">&#123;1: &#x27;1436.jpg&#x27;, 2: &#x27;1437.jpg&#x27;, 3: &#x27;1438.jpg&#x27;, 4: &#x27;1439.jpg&#x27;, 5: &#x27;1440.jpg&#x27;, 6: &#x27;1441.jpg&#x27;, 7: &#x27;1442.jpg&#x27;, </span></span><br><span class="line"><span class="string">8: &#x27;1443.jpg&#x27;, 9: &#x27;1444.jpg&#x27;, 10: &#x27;1445.jpg&#x27;, 11: &#x27;1446.jpg&#x27;, 12: &#x27;1447.jpg&#x27;, 13: &#x27;1448.jpg&#x27;, 14: &#x27;1449.jpg&#x27;, </span></span><br><span class="line"><span class="string">15: &#x27;1450.jpg&#x27;, 16: &#x27;1451.jpg&#x27;, 17: &#x27;1452.jpg&#x27;, 18: &#x27;1453.jpg&#x27;, 19: &#x27;1454.jpg&#x27;, 20: &#x27;1455.jpg&#x27;, 21: &#x27;1456.jpg&#x27;, </span></span><br><span class="line"><span class="string">22: &#x27;1457.jpg&#x27;, 23: &#x27;1458.jpg&#x27;, 24: &#x27;1459.jpg&#x27;, 25: &#x27;1460.jpg&#x27;, 26: &#x27;1461.jpg&#x27;, 27: &#x27;1462.jpg&#x27;, 28: &#x27;1463.jpg&#x27;, </span></span><br><span class="line"><span class="string">29: &#x27;1464.jpg&#x27;, 30: &#x27;1465.jpg&#x27;, 31: &#x27;1466.jpg&#x27;, 32: &#x27;1467.jpg&#x27;, 33: &#x27;1468.jpg&#x27;, 34: &#x27;1469.jpg&#x27;, 35: &#x27;1470.jpg&#x27;, </span></span><br><span class="line"><span class="string">36: &#x27;1471.jpg&#x27;, 37: &#x27;1472.jpg&#x27;, 38: &#x27;1473.jpg&#x27;, 39: &#x27;1474.jpg&#x27;, 40: &#x27;1475.jpg&#x27;, 41: &#x27;1476.jpg&#x27;, 42: &#x27;1477.jpg&#x27;, </span></span><br><span class="line"><span class="string">43: &#x27;1478.jpg&#x27;, 44: &#x27;1479.jpg&#x27;, 45: &#x27;1480.jpg&#x27;, 46: &#x27;1481.jpg&#x27;, 47: &#x27;1482.jpg&#x27;, 48: &#x27;1483.jpg&#x27;, 49: &#x27;1484.jpg&#x27;, </span></span><br><span class="line"><span class="string">50: &#x27;1485.jpg&#x27;, 51: &#x27;1486.jpg&#x27;, 52: &#x27;1487.jpg&#x27;, 53: &#x27;1488.jpg&#x27;, 54: &#x27;1489.jpg&#x27;, 55: &#x27;1490.jpg&#x27;, 56: &#x27;1491.jpg&#x27;, </span></span><br><span class="line"><span class="string">57: &#x27;1492.jpg&#x27;, 58: &#x27;1493.jpg&#x27;, 59: &#x27;1494.jpg&#x27;, 60: &#x27;1495.jpg&#x27;, 61: &#x27;1496.jpg&#x27;, 62: &#x27;1497.jpg&#x27;, 63: &#x27;1498.jpg&#x27;, </span></span><br><span class="line"><span class="string">64: &#x27;1499.jpg&#x27;, 65: &#x27;1500.jpg&#x27;, 66: &#x27;1501.jpg&#x27;, 67: &#x27;1502.jpg&#x27;, 68: &#x27;1503.jpg&#x27;, 69: &#x27;1504.jpg&#x27;, 70: &#x27;1505.jpg&#x27;, </span></span><br><span class="line"><span class="string">71: &#x27;1506.jpg&#x27;, 72: &#x27;1507.jpg&#x27;, 73: &#x27;1508.jpg&#x27;, 74: &#x27;1509.jpg&#x27;, 75: &#x27;1510.jpg&#x27;, 76: &#x27;1511.jpg&#x27;, 77: &#x27;1512.jpg&#x27;, </span></span><br><span class="line"><span class="string">78: &#x27;1513.jpg&#x27;, 79: &#x27;1514.jpg&#x27;, 80: &#x27;1515.jpg&#x27;, 81: &#x27;1516.jpg&#x27;, 82: &#x27;1517.jpg&#x27;, 83: &#x27;1518.jpg&#x27;, 84: &#x27;1519.jpg&#x27;, </span></span><br><span class="line"><span class="string">85: &#x27;1520.jpg&#x27;, 86: &#x27;1521.jpg&#x27;, 87: &#x27;1522.jpg&#x27;, 88: &#x27;1523.jpg&#x27;, 89: &#x27;1524.jpg&#x27;, 90: &#x27;1525.jpg&#x27;, 91: &#x27;1526.jpg&#x27;, </span></span><br><span class="line"><span class="string">92: &#x27;1527.jpg&#x27;, 93: &#x27;1528.jpg&#x27;, 94: &#x27;1529.jpg&#x27;, 95: &#x27;1530.jpg&#x27;, 96: &#x27;1531.jpg&#x27;, 97: &#x27;1532.jpg&#x27;&#125;, </span></span><br><span class="line"><span class="string">[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, </span></span><br><span class="line"><span class="string">30, 31, 32, 33, 34, 35, 36, 37, 38, 39, 40, 41, 42, 43, 44, 45, 46, 47, 48, 49, 50, 51, 52, 53, 54, 55, 56, </span></span><br><span class="line"><span class="string">57, 58, 59, 60, 61, 62, 63, 64, 65, 66, 67, 68, 69, 70, 71, 72, 73, 74, 75, 76, 77, 78, 79, 80, 81, 82, 83, </span></span><br><span class="line"><span class="string">84, 85, 86, 87, 88, 89, 90, 91, 92, 93, 94, 95, 96, 97]]</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<h1 id="Network-amp-Render"><a href="#Network-amp-Render" class="headerlink" title="Network&amp;Render"></a>Network&amp;Render</h1><h2 id="NeROShapeRenderer"><a href="#NeROShapeRenderer" class="headerlink" title="NeROShapeRenderer"></a>NeROShapeRenderer</h2><h3 id="MLP"><a href="#MLP" class="headerlink" title="MLP"></a>MLP</h3><p><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728142918.png" alt="image.png"></p>
<ul>
<li><p>SDFNetwork</p>
<ul>
<li><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/SDFNetwork_modify.png" alt="SDFNetwork"></li>
<li>39—&gt;256—&gt;256—&gt;256—&gt;217—&gt;256—&gt;256—&gt;256—&gt;256—&gt;257</li>
</ul>
</li>
<li><p>NeRFNetwork</p>
<ul>
<li><img src="https://raw.githubusercontent.com/yq010105/Blog_images/main/Pasted%20image%2020221206180113.png" alt="Pasted image 20221206180113.png|600"></li>
<li>84—&gt;256—&gt;256—&gt;256—&gt;256—&gt;256+84—&gt;256—&gt;256—&gt;256+27—&gt;128—&gt;3</li>
<li>84—&gt;256—&gt;256—&gt;256—&gt;256—&gt;256+84—&gt;256—&gt;256—&gt;256—&gt;1</li>
</ul>
</li>
<li><p>AppShadingNetwork</p>
<ul>
<li>metallic_predictor<ul>
<li>259—&gt;256—&gt;256—&gt;256—&gt;1</li>
<li>259 = (256 + 3) = (feature + points)</li>
</ul>
</li>
<li>roughness_predictor<ul>
<li>259—&gt;256—&gt;256—&gt;256—&gt;1</li>
</ul>
</li>
<li>albedo_predictor<ul>
<li>259—&gt;256—&gt;256—&gt;256—&gt;3</li>
</ul>
</li>
<li>outer_light 直接光<ul>
<li>72—&gt;256—&gt;256—&gt;256—&gt;3</li>
<li>72 = ref_roughness = self.sph_enc(reflective, roughness)</li>
<li>or self.sph_enc(normals, roughness) —&gt; diffuse_lights</li>
</ul>
</li>
<li>inner_light 间接光<ul>
<li>123—&gt;256—&gt;256—&gt;256—&gt;3</li>
<li>123 = (51 + 72) = (pts + ref_roughness) <ul>
<li>pts : 2x3x8 + 3 = 51 (L=8)</li>
</ul>
</li>
</ul>
</li>
<li>inner_weight 遮挡概率occ_prob<ul>
<li>90—&gt;256—&gt;256—&gt;256—&gt;1</li>
<li>90 = (51 + 39) = (pts + ref_)<ul>
<li>ref_ = self.dir_enc(reflective)  = 2x3x6 + 3 = 39(L=6)</li>
</ul>
</li>
</ul>
</li>
<li>human_light_predictor  $[\alpha_{\mathrm{camera}},\mathrm{c}_{\mathrm{camera}}]=g_{\mathrm{camera}}(\mathrm{p}_{\mathrm{c}}),$<ul>
<li>24—&gt;256—&gt;256—&gt;256—&gt;4</li>
<li>24 = pos_enc = IPE(mean, var, 0, 6)</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>MLP</th>
<th>Encoding</th>
<th>in_dims</th>
<th>out_dims</th>
<th>layer</th>
<th>neurons</th>
</tr>
</thead>
<tbody>
<tr>
<td>SDFNetwork</td>
<td>VanillaFrequency(L=6)</td>
<td>2x3x6+3=39</td>
<td>257</td>
<td>8</td>
<td>256</td>
</tr>
<tr>
<td>SingleVarianceNetwork</td>
<td>None</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>NeRFNetwork</td>
<td>VanillaFrequency(Lp=10,Lv=4)</td>
<td>2x4x10+4=84(Nerf++:4) &amp; 2x3x4+3=27</td>
<td>4</td>
<td>8</td>
<td>256</td>
</tr>
<tr>
<td>AppShadingNetwork</td>
<td>VanillaFrequency</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>metallic_predictor</td>
<td>None</td>
<td>256 + 3 = 259</td>
<td>1</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>roughness_predictor</td>
<td>None</td>
<td>256 + 3 = 259</td>
<td>1</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>albedo_predictor</td>
<td>None</td>
<td>256 + 3 = 259</td>
<td>3</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>outer_light</td>
<td>IDE(Ref-NeRF)</td>
<td>72</td>
<td>3</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>inner_light</td>
<td>VanillaFrequency+IDE</td>
<td>51 + 72 = 123</td>
<td>3</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>inner_weight</td>
<td>VanillaFrequency</td>
<td>51 + 39 = 90</td>
<td>1</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>human_light_predictor</td>
<td>IPE</td>
<td>2 x 2 x 6 = 24</td>
<td>4</td>
<td>4</td>
<td>256</td>
</tr>
</tbody>
</table>
</div>
<ul>
<li>FG_LUT: <code>[1,256,256,2]</code><ul>
<li>from assets/bsdf_256_256.bin</li>
</ul>
</li>
</ul>
<p><strong>weight_norm:</strong> weight_v, weight_g<br><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230803155215.png" alt="image.png"></p>
<h3 id="Render"><a href="#Render" class="headerlink" title="Render"></a>Render</h3><ul>
<li><code>_init_dataset</code><ul>
<li>parse_database_name：<code>self.database = GlossyRealDatabase(self.cfg[&#39;database_name&#39;])</code></li>
<li>get_database_split：self.train_ids, self.test_ids is <code>img_ids[1:] , img_ids[:1]</code></li>
<li>build_imgs_info(self.database, self.train_ids)：根据 train_ids 加载 train_imgs_info<ul>
<li>train_imgs_info：{‘imgs’: images, ‘Ks’: Ks, ‘poses’: poses}</li>
</ul>
</li>
<li>imgs_info_to_torch(self.train_imgs_info, device = ‘cpu’)：将train_imgs_info转换为torch、如果为imgs，则permute(0,3,1,2)，然后to device</li>
<li>同上加载test_imgs_info并to torch and to device</li>
<li><code>_construct_ray_batch(self.train_imgs_info)</code> : 返回<code>train_batch = ray_batch</code>, <code>self.train_poses = poses# imn,3,4</code>, <code>tbn = rn = imn * h * w</code>, h, w<ul>
<li><code>&#123;&#39;dirs&#39;: dirs.float().reshape(rn, 3).to(device), &#39;rgbs&#39;: imgs.float().reshape(rn, 3).to(device),&#39;idxs&#39;: idxs.long().reshape(rn, 1).to(device)&#125;</code></li>
<li>pose的<code>[:3,:3]</code>为正交矩阵</li>
</ul>
</li>
<li><code>_shuffle_train_batch</code>将train_batch数据打乱，每个像素点dir和rgb</li>
</ul>
</li>
<li>forward<ul>
<li>is_train:<ul>
<li><code>outputs = self.train_step(step)</code></li>
</ul>
</li>
<li>else:<ul>
<li>index = data[‘index’]</li>
<li>outputs = self.test_step(index, step=step)</li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">train_step</span>(<span class="params">self, step</span>):</span><br><span class="line">    rn = self.cfg[<span class="string">&#x27;train_ray_num&#x27;</span>]</span><br><span class="line">    <span class="comment"># fetch to gpu</span></span><br><span class="line">    train_ray_batch = &#123;k: v[self.train_batch_i:self.train_batch_i + rn].cuda() <span class="keyword">for</span> k, v <span class="keyword">in</span> self.train_batch.items()&#125;</span><br><span class="line">    self.train_batch_i += rn</span><br><span class="line">    <span class="keyword">if</span> self.train_batch_i + rn &gt;= self.tbn: self._shuffle_train_batch() <span class="comment"># 当完成一个tbn = img_nums * h * w时，打乱一次顺序</span></span><br><span class="line">    train_poses = self.train_poses.cuda()</span><br><span class="line">    rays_o, rays_d, near, far, human_poses = self._process_ray_batch(train_ray_batch, train_poses)</span><br><span class="line"></span><br><span class="line">    outputs = self.render(rays_o, rays_d, near, far, human_poses, -<span class="number">1</span>, self.get_anneal_val(step), is_train=<span class="literal">True</span>, step=step)</span><br><span class="line">    outputs[<span class="string">&#x27;loss_rgb&#x27;</span>] = self.compute_rgb_loss(outputs[<span class="string">&#x27;ray_rgb&#x27;</span>], train_ray_batch[<span class="string">&#x27;rgbs&#x27;</span>])  <span class="comment"># ray_loss</span></span><br><span class="line">    <span class="keyword">return</span> outputs</span><br></pre></td></tr></table></figure>
<h4 id="train-step"><a href="#train-step" class="headerlink" title="train_step"></a>train_step</h4><ul>
<li><code>_process_ray_batch</code><ul>
<li>input：ray_batch, poses</li>
<li>output：rays_o, rays_d, near, far, human_poses[idxs]</li>
<li>将原世界坐标系下o点转换到手动设置的世界坐标系w’下，并将ray_batch中的dirs转换到手动设置的世界坐标系w’下</li>
<li>near_far_from_sphere:<ul>
<li>get near and far through rays_o, rays_d</li>
</ul>
</li>
<li>get_human_coordinate_poses<ul>
<li>根据pose得到human_poses（w2c）：用于判断从相机发出的光线在物体上反射是否击中human</li>
<li>human_poses: 在相机原点处（相机原点不动），z轴为原相机坐标系z轴在<strong>与w’的xoy平面平行的xoy’平面</strong>的投影单位向量，y轴为w’下z-方向的单位向量</li>
<li><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230728143216.png" alt="image.png"></li>
</ul>
</li>
</ul>
</li>
<li>get_anneal_val(step)<ul>
<li>if self.cfg[‘anneal_end’] &lt; 0 : <code>1</code></li>
<li>else : <code>np.min([1.0, step / self.cfg[&#39;anneal_end&#39;]])</code></li>
</ul>
</li>
<li>render(rays_o, rays_d, near, far, human_poses, perturb_overwrite=-1, cos_anneal_ratio=0.0, is_train=True, step=None)<ul>
<li>input: rays_o, rays_d, near, far, human_poses, -1, self.get_anneal_val(step), is_train=True, step=step</li>
<li>output: ret = outputs</li>
<li>sample_ray(rays_o, rays_d, near, far, perturb)<ul>
<li>同neus，上采样+cat_z_vals堆叠z_vals</li>
</ul>
</li>
<li>render_core<ul>
<li>input: rays_o, rays_d, z_vals, human_poses, cos_anneal_ratio=cos_anneal_ratio, step=step, is_train=is_train</li>
<li>output: outputs</li>
<li>get dists , mid_z_vals , points , inner_mask , outer_mask ,dirs , human_poses_pt</li>
<li>if torch.sum(outer_mask) &gt; 0: 背景使用NeRF网络得到颜色和不透明度<ul>
<li><code>alpha[outer_mask], sampled_color[outer_mask] = self.compute_density_alpha(points[outer_mask], dists[outer_mask], -dirs[outer_mask], self.outer_nerf)</code></li>
</ul>
</li>
<li>if torch.sum(inner_mask) &gt; 0: 前景使用SDF和Color网络得到sdf和颜色、碰撞信息 ， else：<code>gradient_error = torch.zeros(1)</code><ul>
<li><code>alpha[inner_mask], gradients, feature_vector, inv_s, sdf = self.compute_sdf_alpha(points[inner_mask], dists[inner_mask], dirs[inner_mask], cos_anneal_ratio, step)</code></li>
<li><code>sampled_color[inner_mask], occ_info = self.color_network(points[inner_mask], gradients, -dirs[inner_mask], feature_vector, human_poses_pt[inner_mask], step=step)</code><ul>
<li>sampled_color : 采样点颜色</li>
<li>occ_info : dict {‘reflective’: reflective, ‘occ_prob’: occ_prob,}</li>
</ul>
</li>
<li><code>gradient_error = (torch.linalg.norm(gradients, ord=2, dim=-1) - 1.0) ** 2</code> 梯度损失</li>
</ul>
</li>
<li>alpha — &gt; weight </li>
<li>sampled_color, weight —&gt; color</li>
<li>outputs = {‘ray_rgb’: color,  ‘gradient_error’: gradient_error,}</li>
<li><code>if torch.sum(inner_mask) &gt; 0: outputs[&#39;std&#39;] = torch.mean(1 / inv_s)</code>  | <code>else:  outputs[&#39;std&#39;] = torch.zeros(1)</code></li>
<li>if step &lt; 1000: <ul>
<li>mask = torch.norm(points, dim=-1) &lt; 1.2</li>
<li><code>outputs[&#39;sdf_pts&#39;] = points[mask]</code></li>
<li><code>outputs[&#39;sdf_vals&#39;] = self.sdf_network.sdf(points[mask])[..., 0]</code></li>
</ul>
</li>
<li><code>if self.cfg[&#39;apply_occ_loss&#39;]:</code><ul>
<li>if torch.sum(inner_mask) &gt; 0: <code>outputs[&#39;loss_occ&#39;] = self.compute_occ_loss(occ_info, points[inner_mask], sdf, gradients, dirs[inner_mask], step)</code><ul>
<li>compute_occ_loss 碰撞损失</li>
</ul>
</li>
<li>else: <code>outputs[&#39;loss_occ&#39;] = torch.zeros(1)</code></li>
</ul>
</li>
<li>if not is_train: <code>outputs.update(self.compute_validation_info(z_vals, rays_o, rays_d, weights, human_poses, step))</code></li>
<li>return outputs</li>
</ul>
</li>
</ul>
</li>
<li><strong>rgb_loss</strong>: <code>outputs[&#39;loss_rgb&#39;] = self.compute_rgb_loss(outputs[&#39;ray_rgb&#39;], train_ray_batch[&#39;rgbs&#39;])</code></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cfg[<span class="string">&#x27;rgb_loss&#x27;</span>] = <span class="string">&#x27;charbonier&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">compute_rgb_loss</span>(<span class="params">self, rgb_pr, rgb_gt</span>):</span><br><span class="line">    <span class="keyword">if</span> self.cfg[<span class="string">&#x27;rgb_loss&#x27;</span>] == <span class="string">&#x27;l2&#x27;</span>:</span><br><span class="line">        rgb_loss = torch.<span class="built_in">sum</span>((rgb_pr - rgb_gt) ** <span class="number">2</span>, -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> self.cfg[<span class="string">&#x27;rgb_loss&#x27;</span>] == <span class="string">&#x27;l1&#x27;</span>:</span><br><span class="line">        rgb_loss = torch.<span class="built_in">sum</span>(F.l1_loss(rgb_pr, rgb_gt, reduction=<span class="string">&#x27;none&#x27;</span>), -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> self.cfg[<span class="string">&#x27;rgb_loss&#x27;</span>] == <span class="string">&#x27;smooth_l1&#x27;</span>:</span><br><span class="line">        rgb_loss = torch.<span class="built_in">sum</span>(F.smooth_l1_loss(rgb_pr, rgb_gt, reduction=<span class="string">&#x27;none&#x27;</span>, beta=<span class="number">0.25</span>), -<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">elif</span> self.cfg[<span class="string">&#x27;rgb_loss&#x27;</span>] == <span class="string">&#x27;charbonier&#x27;</span>:</span><br><span class="line">        epsilon = <span class="number">0.001</span></span><br><span class="line">        rgb_loss = torch.sqrt(torch.<span class="built_in">sum</span>((rgb_gt - rgb_pr) ** <span class="number">2</span>, dim=-<span class="number">1</span>) + epsilon)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="keyword">raise</span> NotImplementedError</span><br><span class="line">    <span class="keyword">return</span> rgb_loss</span><br></pre></td></tr></table></figure>
<p><strong>render core</strong> : MLP output<br><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/render_core.png" alt="render_core.png"></p>
<p><strong>Occ related</strong>: Occ prob and loss_occ</p>
<p><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/occ.png" alt="occ.png"></p>
<h5 id="loss-occ"><a href="#loss-occ" class="headerlink" title="loss_occ"></a>loss_occ</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">inter_dist, inter_prob, inter_sdf = get_intersection(self.sdf_inter_fun, self.deviation_network, points[mask], reflective[mask], sn0=<span class="number">64</span>, sn1=<span class="number">16</span>)  <span class="comment"># pn,sn-1</span></span><br><span class="line">occ_prob_gt = torch.<span class="built_in">sum</span>(inter_prob, -<span class="number">1</span>, keepdim=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">return</span> F.l1_loss(occ_prob[mask], occ_prob_gt)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_intersection</span>(<span class="params">sdf_fun, inv_fun, pts, dirs, sn0=<span class="number">128</span>, sn1=<span class="number">9</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    :param sdf_fun:</span></span><br><span class="line"><span class="string">    :param inv_fun:</span></span><br><span class="line"><span class="string">    :param pts:    pn,3</span></span><br><span class="line"><span class="string">    :param dirs:   pn,3</span></span><br><span class="line"><span class="string">    :param sn0: # 64</span></span><br><span class="line"><span class="string">    :param sn1: # 16</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    inside_mask = torch.norm(pts, dim=-<span class="number">1</span>) &lt; <span class="number">0.999</span> <span class="comment"># left some margin</span></span><br><span class="line">    pn, _ = pts.shape</span><br><span class="line">    hit_z_vals = torch.zeros([pn, sn1-<span class="number">1</span>])</span><br><span class="line">    hit_weights = torch.zeros([pn, sn1-<span class="number">1</span>])</span><br><span class="line">    hit_sdf = -torch.ones([pn, sn1-<span class="number">1</span>])</span><br><span class="line">    <span class="keyword">if</span> torch.<span class="built_in">sum</span>(inside_mask)&gt;<span class="number">0</span>:</span><br><span class="line">        pts = pts[inside_mask]</span><br><span class="line">        dirs = dirs[inside_mask]</span><br><span class="line">        max_dist = get_sphere_intersection(pts, dirs) <span class="comment"># pn,1</span></span><br><span class="line">        <span class="keyword">with</span> torch.no_grad():</span><br><span class="line">            z_vals = torch.linspace(<span class="number">0</span>, <span class="number">1</span>, sn0) <span class="comment"># sn0</span></span><br><span class="line">            z_vals = max_dist * z_vals.unsqueeze(<span class="number">0</span>) <span class="comment"># pn,sn0</span></span><br><span class="line">            weights, mid_sdf = get_weights(sdf_fun, inv_fun, z_vals, pts, dirs) <span class="comment"># pn,sn0-1</span></span><br><span class="line">            z_vals_new = sample_pdf(z_vals, weights, sn1, <span class="literal">True</span>) <span class="comment"># pn,sn1</span></span><br><span class="line">            weights, mid_sdf = get_weights(sdf_fun, inv_fun, z_vals_new, pts, dirs) <span class="comment"># pn,sn1-1</span></span><br><span class="line">            z_vals_mid = (z_vals_new[:,<span class="number">1</span>:] + z_vals_new[:,:-<span class="number">1</span>]) * <span class="number">0.5</span></span><br><span class="line">        hit_z_vals[inside_mask] = z_vals_mid</span><br><span class="line">        hit_weights[inside_mask] = weights</span><br><span class="line">        hit_sdf[inside_mask] = mid_sdf</span><br><span class="line">    <span class="keyword">return</span> hit_z_vals, hit_weights, hit_sdf</span><br></pre></td></tr></table></figure>
<p>反射光线与单位球交点，到pts的距离dist</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_sphere_intersection</span>(<span class="params">pts, dirs</span>):</span><br><span class="line">    dtx = torch.<span class="built_in">sum</span>(pts*dirs,dim=-<span class="number">1</span>,keepdim=<span class="literal">True</span>) <span class="comment"># rn,1</span></span><br><span class="line">    xtx = torch.<span class="built_in">sum</span>(pts**<span class="number">2</span>,dim=-<span class="number">1</span>,keepdim=<span class="literal">True</span>) <span class="comment"># rn,1</span></span><br><span class="line">    dist = dtx ** <span class="number">2</span> - xtx + <span class="number">1</span></span><br><span class="line">    <span class="keyword">assert</span> torch.<span class="built_in">sum</span>(dist&lt;<span class="number">0</span>)==<span class="number">0</span></span><br><span class="line">    dist = -dtx + torch.sqrt(dist+<span class="number">1e-6</span>) <span class="comment"># rn,1</span></span><br><span class="line">    <span class="keyword">return</span> dist</span><br></pre></td></tr></table></figure>
<p><img src="https://raw.githubusercontent.com/qiyun71/Blog_images/main/pictures/20230805163513.png" alt="image.png"></p>
<p>从pts采样点，长度dist，方向为reflective，均匀采样sn个点</p>
<ul>
<li>获取sn个采样点的sn-1个中点的坐标、sdf和invs</li>
<li>选取其中在物体表面上的点：<code>surface_mask = (cos_val &lt; 0)</code></li>
<li>计算这些点的sdf和权重</li>
<li>表面采样点的权重之和即为occ_prob_gt</li>
<li>occ_prob_gt与occ_prob进行求L1损失即为loss_occ</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_weights</span>(<span class="params">sdf_fun, inv_fun, z_vals, origins, dirs</span>):</span><br><span class="line">    points = z_vals.unsqueeze(-<span class="number">1</span>) * dirs.unsqueeze(-<span class="number">2</span>) + origins.unsqueeze(-<span class="number">2</span>) <span class="comment"># pn,sn,3</span></span><br><span class="line">    inv_s = inv_fun(points[:, :-<span class="number">1</span>, :])[..., <span class="number">0</span>]  <span class="comment"># pn,sn-1</span></span><br><span class="line">    sdf = sdf_fun(points)[..., <span class="number">0</span>]  <span class="comment"># pn,sn</span></span><br><span class="line"></span><br><span class="line">    prev_sdf, next_sdf = sdf[:, :-<span class="number">1</span>], sdf[:, <span class="number">1</span>:]  <span class="comment"># pn,sn-1</span></span><br><span class="line">    prev_z_vals, next_z_vals = z_vals[:, :-<span class="number">1</span>], z_vals[:, <span class="number">1</span>:]</span><br><span class="line">    mid_sdf = (prev_sdf + next_sdf) * <span class="number">0.5</span></span><br><span class="line">    cos_val = (next_sdf - prev_sdf) / (next_z_vals - prev_z_vals + <span class="number">1e-5</span>)  <span class="comment"># pn,sn-1</span></span><br><span class="line">    surface_mask = (cos_val &lt; <span class="number">0</span>)  <span class="comment"># pn,sn-1</span></span><br><span class="line">    cos_val = torch.clamp(cos_val, <span class="built_in">max</span>=<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">    dist = next_z_vals - prev_z_vals  <span class="comment"># pn,sn-1</span></span><br><span class="line">    prev_esti_sdf = mid_sdf - cos_val * dist * <span class="number">0.5</span>  <span class="comment"># pn, sn-1</span></span><br><span class="line">    next_esti_sdf = mid_sdf + cos_val * dist * <span class="number">0.5</span></span><br><span class="line">    prev_cdf = torch.sigmoid(prev_esti_sdf * inv_s)</span><br><span class="line">    next_cdf = torch.sigmoid(next_esti_sdf * inv_s)</span><br><span class="line">    alpha = (prev_cdf - next_cdf + <span class="number">1e-5</span>) / (prev_cdf + <span class="number">1e-5</span>) * surface_mask.<span class="built_in">float</span>()</span><br><span class="line">    weights = alpha * torch.cumprod(torch.cat([torch.ones([alpha.shape[<span class="number">0</span>], <span class="number">1</span>]), <span class="number">1.</span> - alpha + <span class="number">1e-7</span>], -<span class="number">1</span>), -<span class="number">1</span>)[:, :-<span class="number">1</span>]</span><br><span class="line">    mid_sdf[~surface_mask]=-<span class="number">1.0</span></span><br><span class="line">    <span class="keyword">return</span> weights, mid_sdf</span><br></pre></td></tr></table></figure>
<h2 id="NeROMaterialRenderer"><a href="#NeROMaterialRenderer" class="headerlink" title="NeROMaterialRenderer"></a>NeROMaterialRenderer</h2><h3 id="MLP-1"><a href="#MLP-1" class="headerlink" title="MLP"></a>MLP</h3><p>shader_network = MCShadingNetwork</p>
<ul>
<li>feats_network = MaterialFeatsNetwork<ul>
<li>51—&gt;256—&gt;256—&gt;256—&gt;256+51—&gt;256—&gt;256—&gt;256—&gt;256</li>
<li>51: pts = get_embedder(8,3)(x) = 8 x 2 x 3 + 3 = 51</li>
</ul>
</li>
<li>metallic_predictor<ul>
<li>259—&gt;256—&gt;256—&gt;256—&gt;1</li>
<li>259 = 256(feature) + 3(pts)</li>
</ul>
</li>
<li>roughness_predictor<ul>
<li>259—&gt;256—&gt;256—&gt;256—&gt;1</li>
</ul>
</li>
<li>albedo_predictor<ul>
<li>259—&gt;256—&gt;256—&gt;256—&gt;3</li>
</ul>
</li>
<li>outer_light<ul>
<li>144—&gt;256—&gt;256—&gt;256—&gt;3</li>
<li>144 = 72 x 2 = <code>torch.cat([outer_enc, sphere_pts], -1)</code><ul>
<li>outer_enc = self.sph_enc(directions, 0) = 72</li>
<li>sphere_pts = self.sph_enc(sphere_pts, 0) = 72</li>
</ul>
</li>
</ul>
</li>
<li>human_light<ul>
<li>24—&gt;256—&gt;256—&gt;256—&gt;4</li>
<li>24: <code>pos_enc = IPE(mean, var, 0, 6)  # 2*2*6</code></li>
</ul>
</li>
<li>inner_light<ul>
<li>123(51 + 72)—&gt;256—&gt;256—&gt;256—&gt;3</li>
<li>123 = <code>torch.cat([pos_enc, dir_enc], -1)</code><ul>
<li>pos_enc = self.pos_enc(points)  = 51<ul>
<li>self.pos_enc = get_embedder(8, 3)</li>
</ul>
</li>
<li>dir_enc = self.sph_enc(reflections, 0) = 72</li>
</ul>
</li>
</ul>
</li>
</ul>
<div class="table-container">
<table>
<thead>
<tr>
<th>MLP</th>
<th>Encoding</th>
<th>in_dims</th>
<th>out_dims</th>
<th>layer</th>
<th>neurons</th>
</tr>
</thead>
<tbody>
<tr>
<td>light_pts</td>
<td>single parameter</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>MCShadingNetwork</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
<td>…</td>
</tr>
<tr>
<td>feats_network</td>
<td>VanillaFrequency</td>
<td>8 x 2 x 3 + 3 = 51</td>
<td>256</td>
<td>8</td>
<td>256</td>
</tr>
<tr>
<td>metallic_predictor</td>
<td>None</td>
<td>256 + 3 = 259</td>
<td>1</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>roughness_predictor</td>
<td>None</td>
<td>256 + 3 = 259</td>
<td>1</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>albedo_predictor</td>
<td>None</td>
<td>256 + 3 = 259</td>
<td>3</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>outer_light</td>
<td>IDE</td>
<td>72 + 72 = 144</td>
<td>3</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>human_light</td>
<td>IPE</td>
<td>2 x 2 x 6 = 24</td>
<td>4</td>
<td>4</td>
<td>256</td>
</tr>
<tr>
<td>inner_light</td>
<td>VanillaFrequency+IDE</td>
<td>51 + 72 = 123</td>
<td>3</td>
<td>4</td>
<td>256</td>
</tr>
</tbody>
</table>
</div>
<h3 id="Render-1"><a href="#Render-1" class="headerlink" title="Render"></a>Render</h3><ul>
<li><code>_init_geometry</code><ul>
<li>self.mesh = open3d.io.read_triangle_mesh(self.cfg[‘mesh’]) 读取 Stage1得到的mesh<ul>
<li><a target="_blank" rel="noopener" href="http://www.open3d.org/docs/0.16.0/python_api/open3d.io.read_triangle_mesh.html#open3d.io.read_triangle_mesh">open3d.io.read_triangle_mesh — Open3D 0.16.0 documentation</a></li>
</ul>
</li>
<li>self.ray_tracer = raytracing.RayTracer(np.asarray(self.mesh.vertices), np.asarray(self.mesh.triangles)) 获得raytracer,用于根据rays_o和rays_d得到intersections, face_normals, depth<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/ashawkey/raytracing">ashawkey/raytracing: A CUDA Mesh RayTracer with BVH acceleration, with python bindings and a GUI. (github.com)</a></li>
</ul>
</li>
</ul>
</li>
<li><code>_init_dataset</code><ul>
<li>parse_database_name 返回<code>self.database = GlossyRealDatabase(self.cfg[&#39;database_name&#39;])</code></li>
<li>get_database_split :  <code>self.train_ids, self.test_ids =img_ids[1:], img_ids[:1]</code></li>
<li>if is_train:<ul>
<li>build_imgs_info : train and test <ul>
<li>return {‘imgs’: images, ‘Ks’: Ks, ‘poses’: poses}</li>
</ul>
</li>
<li>imgs_info_to_torch : train and test</li>
<li><code>_construct_ray_batch(train_imgs_info)</code><ul>
<li>train_imgs_info to ray_batch</li>
</ul>
</li>
<li>tbn = imn</li>
<li><code>_shuffle_train_batch</code></li>
</ul>
</li>
</ul>
</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">_init_dataset</span>(<span class="params">self, is_train</span>):</span><br><span class="line">    <span class="comment"># train/test split</span></span><br><span class="line">    self.database = parse_database_name(self.cfg[<span class="string">&#x27;database_name&#x27;</span>])</span><br><span class="line">    self.train_ids, self.test_ids = get_database_split(self.database, <span class="string">&#x27;validation&#x27;</span>)</span><br><span class="line">    self.train_ids = np.asarray(self.train_ids)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> is_train:</span><br><span class="line">        self.train_imgs_info = build_imgs_info(self.database, self.train_ids)</span><br><span class="line">        self.train_imgs_info = imgs_info_to_torch(self.train_imgs_info, <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">        self.train_num = <span class="built_in">len</span>(self.train_ids)</span><br><span class="line"></span><br><span class="line">        self.test_imgs_info = build_imgs_info(self.database, self.test_ids)</span><br><span class="line">        self.test_imgs_info = imgs_info_to_torch(self.test_imgs_info, <span class="string">&#x27;cpu&#x27;</span>)</span><br><span class="line">        self.test_num = <span class="built_in">len</span>(self.test_ids)</span><br><span class="line"></span><br><span class="line">        self.train_batch = self._construct_ray_batch(self.train_imgs_info)</span><br><span class="line">        self.tbn = self.train_batch[<span class="string">&#x27;rays_o&#x27;</span>].shape[<span class="number">0</span>]</span><br><span class="line">        self._shuffle_train_batch()</span><br><span class="line"></span><br><span class="line">self.train_batch <span class="keyword">from</span> _construct_ray_batch<span class="string">&#x27;s return ray_batch: </span></span><br><span class="line"><span class="string">if is_train:</span></span><br><span class="line"><span class="string">    ray_batch=&#123;</span></span><br><span class="line"><span class="string">        &#x27;</span>rays_o<span class="string">&#x27;: rays_o[hit_mask].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>rays_d<span class="string">&#x27;: rays_d[hit_mask].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>inters<span class="string">&#x27;: inters[hit_mask].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>normals<span class="string">&#x27;: normals[hit_mask].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>depth<span class="string">&#x27;: depth[hit_mask].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>human_poses<span class="string">&#x27;: human_poses[hit_mask].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>rg<span class="string">b&#x27;: rgb[hit_mask].to(device),</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">else:</span></span><br><span class="line"><span class="string">    assert imn==1</span></span><br><span class="line"><span class="string">    ray_batch=&#123;</span></span><br><span class="line"><span class="string">        &#x27;</span>rays_o<span class="string">&#x27;: rays_o[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>rays_d<span class="string">&#x27;: rays_d[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>inters<span class="string">&#x27;: inters[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>normals<span class="string">&#x27;: normals[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>depth<span class="string">&#x27;: depth[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>human_poses<span class="string">&#x27;: human_poses[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>rg<span class="string">b&#x27;: rgb[0].to(device),</span></span><br><span class="line"><span class="string">        &#x27;</span>hit_mask<span class="string">&#x27;: hit_mask[0].to(device),</span></span><br><span class="line"><span class="string">    &#125;</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>_init_shader</code><ul>
<li><code>self.cfg[&#39;shader_cfg&#39;][&#39;is_real&#39;] = self.cfg[&#39;database_name&#39;].startswith(&#39;real&#39;)</code></li>
<li><code>self.shader_network = MCShadingNetwork(self.cfg[&#39;shader_cfg&#39;], lambda o,d: self.trace(o,d))</code> — MLP Network</li>
</ul>
</li>
<li>forward<ul>
<li>if is_train: self.train_step(step)</li>
</ul>
</li>
</ul>
<h1 id="Relight"><a href="#Relight" class="headerlink" title="Relight"></a>Relight</h1><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python relight.py --blender &lt;<span class="built_in">path</span>-to-your-blender&gt; \</span><br><span class="line">                  --name bear-neon \</span><br><span class="line">                  --mesh data/meshes/bear_shape-<span class="number">300000</span>.ply \</span><br><span class="line">                  --material data/materials/bear_material-<span class="number">100000</span> \</span><br><span class="line">                  --hdr data/hdr/neon_photostudio_4k.exr</span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">eg: </span></span><br><span class="line"><span class="function"><span class="title">python</span> <span class="title">relight.py</span> --<span class="title">blender</span> <span class="title">F</span>:\<span class="title">Blender</span>\<span class="title">blender.exe</span> --<span class="title">name</span> <span class="title">bear</span>-<span class="title">neon</span> --<span class="title">mesh</span> <span class="title">data</span>/<span class="title">meshes</span>/<span class="title">bear_shape</span>-300000.<span class="title">ply</span> --<span class="title">material</span> <span class="title">data</span>/<span class="title">materials</span>/<span class="title">bear_material</span>-100000 --<span class="title">hdr</span> <span class="title">data</span>/<span class="title">hdr</span>/<span class="title">neon_photostudio_4k.exr</span></span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> argparse</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    parser = argparse.ArgumentParser()</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--blender&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--mesh&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--material&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--hdr&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--name&#x27;</span>, <span class="built_in">type</span>=<span class="built_in">str</span>)</span><br><span class="line">    parser.add_argument(<span class="string">&#x27;--trans&#x27;</span>, dest=<span class="string">&#x27;trans&#x27;</span>, action=<span class="string">&#x27;store_true&#x27;</span>, default=<span class="literal">False</span>)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line"></span><br><span class="line">    cmds=[</span><br><span class="line">        args.blender, <span class="string">&#x27;--background&#x27;</span>, <span class="string">&#x27;--python&#x27;</span>, <span class="string">&#x27;blender_backend/relight_backend.py&#x27;</span>, <span class="string">&#x27;--&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--output&#x27;</span>, <span class="string">f&#x27;data/relight/<span class="subst">&#123;args.name&#125;</span>&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;--mesh&#x27;</span>, args.mesh,</span><br><span class="line">        <span class="string">&#x27;--material&#x27;</span>, args.material,</span><br><span class="line">        <span class="string">&#x27;--env_fn&#x27;</span>, args.hdr,</span><br><span class="line">    ]</span><br><span class="line">    <span class="keyword">if</span> args.trans:</span><br><span class="line">        cmds.append(<span class="string">&#x27;--trans&#x27;</span>)</span><br><span class="line">    subprocess.run(cmds)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<p>运行python relight.py后，子进程在cmd中运行以下命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">F:\Blender\blender.exe --background # 无UI界面渲染，在后台运行</span><br><span class="line">--python blender_backend/relight_backend.py # 运行给定的 Python 脚本文件</span><br><span class="line">-- # 结束option processing，后续参数保持不变。通过 Python 的 sys.argv 访问，下面的参数用于python脚本程序</span><br><span class="line">--output data/relight/bear-neon</span><br><span class="line">--mesh data/meshes/bear_shape-300000.ply</span><br><span class="line">--material data/materials/bear_material-100000</span><br><span class="line">--env_fn  data/hdr/neon_photostudio_4k.exr</span><br><span class="line"></span><br><span class="line">即先后台运行blender，在blender中运行python脚本：</span><br><span class="line">python relight_backend.py --output data/relight/bear-neon</span><br><span class="line">    --mesh data/meshes/bear_shape-300000.ply</span><br><span class="line">    --material data/materials/bear_material-100000</span><br><span class="line">    --env_fn  data/hdr/neon_photostudio_4k.exr</span><br></pre></td></tr></table></figure>
<h2 id="blender中运行的python脚本"><a href="#blender中运行的python脚本" class="headerlink" title="blender中运行的python脚本"></a>blender中运行的python脚本</h2><p><strong>blender_backend/relight_backend.py</strong>: </p>
<p>import bpy</p>
<p><strong>blender_backend/blender_utils.py</strong>: </p>

    </div>

    
    
    
        

  <div class="followme">
    <p>Welcome to my other publishing channels</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="https://t.me/+1ZnNxFWnEbk5YzRl">
            <span class="icon">
              <i class="fab fa-telegram"></i>
            </span>

            <span class="label">Telegram</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          
          <div class="post-tags">
              <a href="/tags/Python/" rel="tag"><i class="fa fa-tag"></i> Python</a>
              <a href="/tags/Neus/" rel="tag"><i class="fa fa-tag"></i> Neus</a>
              <a href="/tags/Code/" rel="tag"><i class="fa fa-tag"></i> Code</a>
              <a href="/tags/Shadow-Highlight/" rel="tag"><i class="fa fa-tag"></i> Shadow&Highlight</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/3DReconstruction/Multi-view/Implicit%20Function/NeRF-based/NeRF%20Other%20Research/Efficiency/Zip-NeRF/" rel="prev" title="Zip-NeRF">
      <i class="fa fa-chevron-left"></i> Zip-NeRF
    </a></div>
      <div class="post-nav-item">
    <a href="/3DReconstruction/Multi-view/Implicit%20Function/NeRF-based/Sparse/FORGE/" rel="next" title="FORGE">
      FORGE <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Dataset"><span class="nav-text">Dataset</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#DummyDataset-Dataset"><span class="nav-text">DummyDataset(Dataset)</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#GlossyRealDatabase"><span class="nav-text">GlossyRealDatabase</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#init"><span class="nav-text">init</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Network-amp-Render"><span class="nav-text">Network&amp;Render</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#NeROShapeRenderer"><span class="nav-text">NeROShapeRenderer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MLP"><span class="nav-text">MLP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Render"><span class="nav-text">Render</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#train-step"><span class="nav-text">train_step</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#loss-occ"><span class="nav-text">loss_occ</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#NeROMaterialRenderer"><span class="nav-text">NeROMaterialRenderer</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MLP-1"><span class="nav-text">MLP</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Render-1"><span class="nav-text">Render</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Relight"><span class="nav-text">Relight</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#blender%E4%B8%AD%E8%BF%90%E8%A1%8C%E7%9A%84python%E8%84%9A%E6%9C%AC"><span class="nav-text">blender中运行的python脚本</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Qi Yun"
      src="/images/avatar.jpeg">
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">164</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">60</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/qiyun71" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;qiyun71" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/29010355" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;29010355" rel="noopener" target="_blank"><i class="fa fa-star fa-fw"></i>Bilibili</a>
      </span>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2025</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qi Yun</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
    <span title="Symbols count total">553k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="Reading time total">33:29</span>
</div>

        








      </div>
    </footer>
  </div>

  
  <script src="/yqq/anime.min.js"></script>
  <script src="/yqq/velocity/velocity.min.js"></script>
  <script src="/yqq/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>


  <script defer src="//cdn.jsdelivr.net/gh/theme-next/theme-next-three@1/three.min.js"></script>


  




  
<script src="/js/local-search.js"></script>













  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
